# Callbacks Configuration

# Model Checkpoint - 保存最佳模型
model_checkpoint:
  _target_: lightning.pytorch.callbacks.ModelCheckpoint
  dirpath: ${paths.output_dir}/checkpoints
  filename: "epoch{epoch:03d}_val_loss{val_loss:.4f}"
  monitor: "val_loss"
  mode: "min"
  save_top_k: 3
  save_last: true
  auto_insert_metric_name: false
  verbose: false

# Early Stopping
early_stopping:
  _target_: lightning.pytorch.callbacks.EarlyStopping
  monitor: "val_loss"
  patience: 50
  mode: "min"
  verbose: true
  min_delta: 0.001

# Learning Rate Monitor
lr_monitor:
  _target_: lightning.pytorch.callbacks.LearningRateMonitor
  logging_interval: "epoch"
  log_momentum: false

# Model Summary
model_summary:
  _target_: lightning.pytorch.callbacks.RichModelSummary
  max_depth: 2

# Progress Bar
rich_progress_bar:
  _target_: lightning.pytorch.callbacks.RichProgressBar
  leave: true
  refresh_rate: 1
  theme:
    _target_: lightning.pytorch.callbacks.progress.rich_progress.RichProgressBarTheme
    description: "bold italic #FF00FF"
    progress_bar: "#6A0DAD"
    progress_bar_finished: "#FF0000"
    progress_bar_pulse: "#00FF00"
    batch_progress: "bold #FF00FF"
    time: "#9370DB"
    processing_speed: "#00FFFF"
    metrics: "bold #FFA500"

# Image Logger
# image_logger:
#   _target_: callbacks.image_logger.ImageLogger
#   num_samples: 4
#   log_key: "val/hand_samples"
image_logger: null

# Device Stats Monitor (GPU/CPU usage)
device_stats_monitor: null
# device_stats_monitor:
#   _target_: callbacks.light_device_stats_monitor.LightDeviceStatsMonitor
#   log_every_n_train_batches: 50
#   log_every_n_val_batches: 50
#   log_every_n_test_batches: 50
#   prefix: "device"

# Stochastic Weight Averaging
stochastic_weight_averaging: null

# stochastic_weight_averaging:
#   _target_: lightning.pytorch.callbacks.StochasticWeightAveraging
#   swa_lrs: 1e-3
#   swa_epoch_start: 0.8

# New Callbacks
ema:
  _target_: callbacks.ema.ModelEma
  decay: 0.999
  ema_device: null
  update_every_n_steps: 20

validation_summary:
  _target_: callbacks.validation_summary.ValidationSummaryCallback

# hand_vis:
#   _target_: callbacks.visualization.HandVisCallback
#   num_samples: 4
#   sample_num_steps: 20

# Gradient Norm Logger (Uncomment to enable)
# grad_norm:
#   _target_: callbacks.grad_norm_logger.GradNormLogger
#   norm_type: 2.0

# Gradient Health Monitor - NaN/Inf detection and emergency alerts
# Enabled by default for safety; set to null to disable
gradient_monitor:
  _target_: callbacks.gradient_monitor.GradientMonitor
  check_nan: true
  check_inf: true
  halt_on_nan: false          # Set true to stop immediately on NaN
  halt_on_inf: false          # Set true to stop immediately on Inf
  max_consecutive_bad_batches: 10  # Stop after N consecutive bad batches (-1 to disable)
  log_param_names: true       # Log which parameters have bad gradients
  log_every_n_steps: 0        # Log gradient stats every N steps (0 to disable)
  raise_exception: false      # Raise exception instead of stopping trainer

# Training ETA - Stores ETA info in run_info for ValidationSummaryCallback
training_eta:
  _target_: callbacks.training_eta.TrainingETACallback
  datetime_format: "%Y-%m-%d %H:%M:%S"

# Checkpoint Validator - Verify checkpoint integrity
checkpoint_validator:
  _target_: callbacks.checkpoint_validator.CheckpointValidator
  validate_on_save: true      # Validate after each checkpoint save
  validate_state_dict: true   # Check for NaN/Inf in saved weights
  validate_loadable: false    # Actually try loading (slower but thorough)
  log_checkpoint: false   # Log checkpoint file size

# DDP Watchdog - Deadlock detection and zombie process cleanup (for multi-GPU)
# Enable in multi-GPU experiments or via experiments=multi_gpu_4
ddp_watchdog: null
# ddp_watchdog:
#   _target_: callbacks.ddp_watchdog.DDPWatchdog
#   step_timeout: 300.0         # Max seconds per step before warning
#   heartbeat_interval: 60.0    # Heartbeat check interval
#   max_consecutive_timeouts: 3 # Stop after N consecutive timeouts
#   barrier_timeout: 1800.0     # DDP barrier timeout
#   kill_zombies: true          # Cleanup zombie processes
#   save_on_timeout: true       # Save emergency checkpoint
#   log_gpu_memory: true        # Log GPU status on timeout

# DDP Barrier Monitor - Monitor barrier operations for deadlocks (for multi-GPU)
ddp_barrier_monitor: null
# ddp_barrier_monitor:
#   _target_: callbacks.ddp_watchdog.DDPBarrierMonitor
#   barrier_timeout: 600.0
#   check_interval: 30.0
