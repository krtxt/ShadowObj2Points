# @package _global_

# Profiler Experiment Configuration
# Usage: python train.py experiment=profiler

defaults:
  - override /trainer: default

# Experiment Metadata
experiment_name: profiler_analysis
tags: ["profiler", "debug", "performance"]

# Trainer Configuration for Profiling
trainer:
  profiler: "advanced"      # Enable advanced profiler
  max_epochs: 3             # Run only 1 epoch
  check_val_every_n_epoch: 1
  limit_train_batches: 50  # Run only 100 batches to save time
  limit_val_batches: 25      # Skip validation to focus on training
  # limit_test_batches: 0     # Skip testing
  num_sanity_val_steps: 0   # Skip sanity check to avoid noise in profile
  log_every_n_steps: 1
  precision: 32             # Use FP32 for accurate profiling (avoid spconv auto-tune noise)
  benchmark: true           # Enable cuDNN benchmark

  # Enable PyTorchProfiler alongside the advanced profiler to capture GPU kernel-level traces.
  # This will write a trace file next to fit-profile_report.txt under the same output dir.
  # NOTE: Lightning uses only one profiler at runtime; we keep the main flag as "advanced"
  # and attach a secondary PyTorchProfiler via callbacks for GPU analysis.
  callbacks:
    gpu_profiler:
      _target_: lightning.pytorch.profilers.PyTorchProfiler
      dirpath: ${paths.output_dir}/profiler
      filename: fit-gpu-trace
      export_to_chrome: true
      record_module_names: true
      profile_memory: true
      with_stack: false
      schedule:
        _target_: torch.profiler.schedule
        skip_first: 10
        wait: 1
        warmup: 1
        active: 3
        repeat: 1

# Disable Auto-Tuning (Profiling needs fixed settings)
auto_scale_batch_size: false
auto_lr_find: false
auto_resume: false

compile: false

# Data Settings (Ensure fast loading for profiling)
batch_size: 128
datamodule:
  num_workers: 16          # Ensure enough workers
  prefetch_factor: 2
  pin_memory: true
  persistent_workers: false

# Logger (Disable heavy logging)
logger:
  _target_: lightning.pytorch.loggers.TensorBoardLogger
  save_dir: ${paths.output_dir}/tensorboard
  name: null
  version: null
  default_hp_metric: false

# Disable callbacks that expect validation metrics
# callbacks:
#   early_stopping: null
#   device_stats_monitor: null
#   hand_vis: null
#   ema: null
