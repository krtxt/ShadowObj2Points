# Deterministic Regression Loss Configuration
# ============================================
#
# Uses component registry for modular loss computation.
# Components with weight=0 are not computed (saves compute).
#
# Available Loss Components (registered in LOSS_COMPONENT_REGISTRY):
# - l1: Position regression (MAE) - Core reconstruction signal
# - chamfer: Bidirectional point cloud distance for global shape consistency
# - direction: Cosine similarity of edge directions - Ensures correct bone orientations
# - edge_len: Relative edge length error - Maintains skeleton proportions
# - bone: Bone length deviation from template - Structural regularization
# - collision: Penetration depth penalty - Prevents hand-object intersection
#
# Two Configuration Modes:
# 1. Simple mode (curriculum.enabled: false): Uses weights section directly
# 2. Curriculum mode (curriculum.enabled: true): Uses multi-stage scheduling

# =============================================================================
# Default Weights (used when curriculum is disabled)
# Components with weight=0 will NOT be computed or returned.
# =============================================================================
weights:
  l1: 2.0             # Primary position loss - high weight for accurate keypoint positions
  chamfer: 1.0        # Shape distribution matching
  direction: 1.0      # Bone orientation consistency
  edge_len: 1.0       # Skeleton proportion maintenance
  bone: 0.0           # Template bone length regularization (set to 0 to skip computation)
  collision: 0.25     # Penetration avoidance (set to 0.0 to disable)

# =============================================================================
# Curriculum Learning Configuration
# =============================================================================
curriculum:
  enabled: true       # Set to true to enable multi-stage training
  warmup_epochs: 5     # Smooth transition epochs between stages

  # Training Stages:
  # Stage 1: Learn basic point positions with reconstruction losses
  # Stage 2: Refine with skeletal structure constraints
  # Stage 3: Add physics-based collision avoidance
  stages:
    - name: reconstruction
      epochs: [0, 30]
      weights:
        l1: 2.0
        chamfer: 1.0
        direction: 0.0    # Lower weight initially - focus on positions first
        edge_len: 0.0
        bone: 0.0
        collision: 0.0    # No collision penalty yet

    - name: structure
      epochs: [30, 60]
      weights:
        l1: 2.0
        chamfer: 1.0
        direction: 1.0    # Full weight for orientation
        edge_len: 1.0     # Full weight for proportions
        bone: 0.5         # Introduce bone regularization
        collision: 0.0    # Still no collision

    - name: physics
      epochs: [60, null]  # null means until end of training
      weights:
        l1: 2.0
        chamfer: 1.0
        direction: 1.0
        edge_len: 1.0
        bone: 1.0
        collision: 0.25   # Finally add collision avoidance

# =============================================================================
# Reconstruction Loss Sub-configs (enable/disable individual terms)
# =============================================================================
recon:
  enabled: true
  scale_factor: 1.0     # Optional: compute recon metrics in centimeters (inputs are meters)
  l1:
    enabled: true
  chamfer:
    enabled: true
    use_pytorch3d: true
  direction:
    enabled: true
    mode: cos           # 'cos' or 'l2'
    eps: 1.0e-06
  edge_len:
    enabled: true
    eps: 1.0e-06

# =============================================================================
# Collision Loss Hyperparameters
# =============================================================================
# Uses analytical point-to-capsule distance (no mesh SDF).
# Computed in CENTIMETER space (denorm * scale) for numerical stability.
# All distance parameters should be in centimeters.
collision_scale: 100.0            # Scale factor: meters -> centimeters
collision_margin: 0.2             # Minimum clearance distance (cm) = 2mm
collision_capsule_radius: 0.8     # Finger capsule radius (cm) = 8mm
collision_max_scene_points: 2048  # Max scene points for collision check
collision_chunk_size: 4096        # Points per chunk for memory efficiency

# =============================================================================
# Validation Metrics (independent of training loss)
# =============================================================================
val_metrics:
  flow:
    enabled: false
  recon:
    enabled: false
